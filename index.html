<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Espetinho Gesselo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <audio id="alertSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
</audio>
    
    <style>
        /* ESTILOS CSS B√ÅSICOS */
        body { font-family: Arial, sans-serif; background-color: #1a1a1a; color: white; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #2c2c2c; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
        .header { text-align: center; margin-bottom: 30px; }
        
        /* ESTILOS DE LOGIN */
        #login-view { text-align: center; padding: 50px; }
        #login-view input { padding: 10px; margin: 10px 0; width: 80%; max-width: 300px; border: none; border-radius: 4px; }
        #login-view button { padding: 10px 20px; background-color: #ff8c00; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }

        /* ESTILOS DE MESAS - AGORA COM NUMERA√á√ÉO ORGANIZADA */
        #mesas-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; text-align: center; }
        .mesa-container { position: relative; }
        .mesa-btn { padding: 25px 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.2s; width: 100%; position: relative; }
        .mesa-btn.livre { background-color: #4CAF50; color: white; }
        .mesa-btn.ocupada { background-color: #FF5733; color: white; }
        .mesa-btn.em_preparo { background-color: #FFC300; color: black; }
        .mesa-btn.pronto { background-color: #00bcd4; color: white; }
        .badge-comandas { position: absolute; top: -8px; right: -8px; background: #ff4081; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 0.8em; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* NOVO: SELE√á√ÉO DE COMANDA */
        #comanda-selection-view { display: none; text-align: center; padding: 20px; }
        .comanda-option { background: #383838; margin: 10px auto; padding: 15px; border-radius: 8px; cursor: pointer; max-width: 400px; border: 2px solid #555; }
        .comanda-option:hover { border-color: #ff8c00; }
        .comanda-option.nova { background: #2d4a2d; border-color: #4CAF50; }
        
        /* ESTILOS DO PDV - DESKTOP */
        #pdv-view { display: none; gap: 20px; }
        .pdv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .comanda-info { background: #383838; padding: 10px 15px; border-radius: 8px; }
        .cardapio-col { flex: 2; overflow-y: auto; max-height: 80vh; padding-right: 10px; }
        .comanda-col { flex: 1; background-color: #383838; padding: 15px; border-radius: 8px; }
        
        .item-cardapio { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #555; }
        .item-cardapio:last-child { border-bottom: none; }
        .item-info { flex-grow: 1; }
        .item-preco { font-weight: bold; margin-right: 10px; color: #ff8c00; }
        .add-btn { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* ESTILOS DA COMANDA */
        #itens-comanda { list-style: none; padding: 0; margin: 10px 0; }
        #itens-comanda li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #555; }
        .remover-btn { background-color: #FF5733; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; margin-left: 5px; }
        
        #total-comanda { font-size: 1.2em; font-weight: bold; margin-top: 15px; border-top: 2px solid #555; padding-top: 10px; }
        #observacao { width: 95%; padding: 10px; border-radius: 4px; border: 1px solid #555; background-color: #444; color: white; margin-bottom: 15px; }
        
        /* ESTILOS DE BOT√ïES DE A√á√ÉO */
        .action-buttons button { width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .imprimir-btn { background-color: #007bff; color: white; }
        .fechar-btn { background-color: #dc3545; color: white; }
        .nova-comanda-btn { background-color: #ff8c00; color: white; margin-bottom: 10px; }

        /* INDICADOR DE ATUALIZA√á√ÉO */
        .status-indicator { position: fixed; top: 10px; right: 10px; padding: 5px 10px; background-color: #4CAF50; color: white; border-radius: 4px; font-size: 0.8em; }

        /* MODAL PARA EDITAR NOME DA COMANDA */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #2c2c2c; margin: 15% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-modal { color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: white; }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0; background: #444; border: 1px solid #555; border-radius: 4px; color: white; }

        /* ESTILOS DE IMPRESS√ÉO */
        @media print {
            body > *:not(#comanda-para-impressao) {
                display: none;
            }
            #comanda-para-impressao {
                display: block !important;
                width: 80mm;
                margin: 0 auto;
            }
            @page {
                margin: 0;
                padding: 0;
            }
        }
        
        /* -------------------------------------- */
        /* NOVO: ESTILOS PARA DISPOSITIVOS M√ìVEIS */
        /* -------------------------------------- */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                padding: 10px;
                border-radius: 0;
                box-shadow: none;
            }
            
            /* MESAS: Otimiza√ß√£o para celular */
            #mesas-view {
                /* Minmax ajustado para caber mais mesas em telas pequenas, no m√≠nimo 120px */
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }
            
            /* PDV: Colunas empilhadas */
            #pdv-view {
                flex-direction: column; /* Empilha o card√°pio e a comanda */
            }

            .cardapio-col {
                order: 2; /* Move o card√°pio para baixo */
                max-height: 60vh; /* Limita a altura para deixar espa√ßo para a comanda */
                padding-right: 0;
                margin-top: 15px;
            }

            .comanda-col {
                order: 1; /* Move a comanda (resumo) para o topo */
                min-height: auto;
            }
            
            .pdv-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .pdv-header > div:first-child {
                margin-bottom: 10px;
            }
            
            .nova-comanda-btn {
                width: 100%;
                margin-top: 5px;
            }

            /* INPUT DE BUSCA: Ocupa toda a largura */
            #busca-input {
                width: 98%; 
            }
            
            /* ITENS DO CARD√ÅPIO: Ajuste o espa√ßamento */
            .item-cardapio {
                padding: 10px 0;
                font-size: 0.9em;
            }
            
            /* COMANDA: Ajuste o tamanho da fonte */
            #itens-comanda li {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>

    <div class="status-indicator" id="status-indicator">‚óè</div>

    <div class="container">
        <div class="header">
            <h1 style="color: #ff8c00;">PDV Espetinho Gesselo</h1>
        </div>

        <div id="login-view">
            <h2>Login</h2>
            <input type="email" id="email-login" placeholder="Email" value="admin@gesselo.com">
            <input type="password" id="senha-login" placeholder="Senha" value="123456">
            <button onclick="fazerLogin()">Entrar</button>
        </div>

        <div id="mesas-view" style="display:none;">
            <h2>Escolha a Mesa</h2>
        </div>

        <div id="comanda-selection-view">
            <h2>Selecione a Comanda - Mesa <span id="mesa-selecionada-numero"></span></h2>
            <div id="comandas-list"></div>
            <div class="comanda-option nova" onclick="criarNovaComanda()">
                <h3>‚ûï Nova Comanda</h3>
                <p>Criar uma nova comanda para esta mesa</p>
            </div>
            <button onclick="showMesasView()" style="margin-top: 20px; padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Voltar</button>
        </div>

        <div id="pdv-view">
            <div class="pdv-header">
                <div>
                    <button onclick="showComandaSelectionView()">‚Üê Voltar para Mesas</button>
                    <div class="comanda-info">
                        <h2 id="pdv-mesa-titulo">Card√°pio (Mesa X)</h2>
                        <div style="font-size: 0.9em; color: #ccc;">
                            Comanda: <span id="comanda-nome-display">Principal</span>
                            <button onclick="editarNomeComanda()" style="margin-left: 10px; padding: 2px 8px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;">Editar</button>
                        </div>
                    </div>
                </div>
                <button class="nova-comanda-btn" onclick="abrirNovaComandaNaMesmaMesa()">‚ûï Nova Comanda nesta Mesa</button>
            </div>
            
            <div class="cardapio-col">
                <input type="text" id="busca-input" placeholder="Buscar no Card√°pio..." onkeyup="carregarCardapio()" style="width: 95%; padding: 10px; margin-bottom: 15px; background-color: #444; color: white; border: 1px solid #555; border-radius: 4px;">
                <div id="cardapio-view">
                </div>
            </div>

            <div class="comanda-col">
                <h3>Comanda Atual</h3>
                <ul id="itens-comanda">
                </ul>
                <div id="total-comanda">Total: R$ 0,00</div>
                
                <h4>Observa√ß√£o da Comanda</h4>
                <textarea id="observacao" placeholder="Ex: Sem pimenta, pouca cebola..."></textarea>
                
                <div class="action-buttons">
                    <button class="imprimir-btn" onclick="enviarParaCozinha()">üñ®Ô∏è Enviar para Cozinha</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-editar-nome" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Nome da Comanda</h3>
                <span class="close-modal" onclick="fecharModalEditarNome()">&times;</span>
            </div>
            <input type="text" id="novo-nome-comanda" class="modal-input" placeholder="Ex: Comanda Principal, Aniversariante...">
            <button onclick="salvarNomeComanda()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Salvar Nome</button>
        </div>
    </div>
    
    <div id="comanda-para-impressao" style="display:none;"></div>

    <script>
        // --- CONFIGURA√á√ïES GLOBAIS ---
        const SUPABASE_URL = 'https://ufxbltjyswbynwnaybev.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmeGJsdGp5c3dieW53bmF5YmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjA3ODksImV4cCI6MjA3NDkzNjc4OX0.Ii4cIbNkUhbQ0T_C9WOXk15RveVI4YzbQ2eXUKMs9kc';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storageKey: 'supabase_auth_gesselo',
                persistSession: true,
                autoRefreshToken: true
            }
        });
        
        // Vari√°veis Globais para o PDV
        let GLOBAL_MESA_ID = null;
        let GLOBAL_COMANDA_ID = null;
        let GLOBAL_ORDER_ITEMS = [];
        let GLOBAL_COMANDA_NOME = "Principal";
        
        // VARI√ÅVEIS PARA M√öLTIPLAS COMANDA
        let GLOBAL_MESA_COMANDAS = [];
        
        // VARI√ÅVEIS PARA POLLING
        let pollingInterval = null;
        const POLLING_INTERVAL_MS = 2000;

        // --- FUN√á√ïES DE NAVEGA√á√ÉO ---

        function showLoginView() {
            stopPolling();
            document.getElementById('login-view').style.display = 'block';
            document.getElementById('mesas-view').style.display = 'none';
            document.getElementById('comanda-selection-view').style.display = 'none';
            document.getElementById('pdv-view').style.display = 'none';
        }

        function showMesasView() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('mesas-view').style.display = 'grid';
            document.getElementById('comanda-selection-view').style.display = 'none';
            document.getElementById('pdv-view').style.display = 'none';
            carregarMesas();
            startPolling();
        }

        function showComandaSelectionView() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('mesas-view').style.display = 'none';
            document.getElementById('comanda-selection-view').style.display = 'block';
            document.getElementById('pdv-view').style.display = 'none';
            carregarComandasDaMesa(GLOBAL_MESA_ID);
        }

        function showPdvView(mesaId) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('mesas-view').style.display = 'none';
            document.getElementById('comanda-selection-view').style.display = 'none';
            document.getElementById('pdv-view').style.display = 'flex';
            document.getElementById('pdv-mesa-titulo').textContent = `Card√°pio (Mesa ${mesaId})`;
            document.getElementById('comanda-nome-display').textContent = GLOBAL_COMANDA_NOME;
            carregarCardapio();
            renderComanda();
        }

        // --- FUN√á√ïES DE POLLING ---

        function startPolling() {
            if (pollingInterval) return;
            
            pollingInterval = setInterval(async () => {
                try {
                    await carregarMesas();
                    updateStatusIndicator(true);
                } catch (error) {
                    console.error('Erro no polling:', error);
                    updateStatusIndicator(false);
                }
            }, POLLING_INTERVAL_MS);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function updateStatusIndicator(success) {
            const indicator = document.getElementById('status-indicator');
            if (success) {
                indicator.style.backgroundColor = '#4CAF50';
                indicator.textContent = '‚óè';
            } else {
                indicator.style.backgroundColor = '#FF5733';
                indicator.textContent = '‚ö†';
            }
        }

        // --- FUN√á√ïES DE M√öLTIPLAS COMANDA ---

        async function carregarComandasDaMesa(mesaId) {
            document.getElementById('mesa-selecionada-numero').textContent = mesaId;
            
            const { data: comandas, error } = await supabaseClient
                .from('pedidos')
                .select('*')
                .eq('mesa', mesaId)
                .neq('status', 'Fechado')
                .order('horario', { ascending: true }); // Ordenar por hor√°rio de chegada

            if (error) {
                console.error('Erro ao carregar comandas:', error);
                return;
            }

            GLOBAL_MESA_COMANDAS = comandas || [];
            renderComandasList();
        }

        function renderComandasList() {
            const container = document.getElementById('comandas-list');
            container.innerHTML = '';

            if (GLOBAL_MESA_COMANDAS.length === 0) {
                container.innerHTML = '<p style="color: #ccc; margin: 20px 0;">Nenhuma comanda aberta</p>';
                return;
            }

            GLOBAL_MESA_COMANDAS.forEach(comanda => {
                const div = document.createElement('div');
                div.className = 'comanda-option';
                div.onclick = () => selecionarComanda(comanda);
                
                const total = comanda.total || 0;
                const status = comanda.status || 'Aberto';
                const nome = comanda.nome_comanda || 'Comanda Principal';
                
                // Formatar hor√°rio
                const horario = comanda.horario ? new Date(comanda.horario).toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '--:--';
                
                div.innerHTML = `
                    <h3>${nome}</h3>
                    <p><strong>Status:</strong> ${status} | <strong>Total:</strong> R$ ${total.toFixed(2).replace('.', ',')}</p>
                    <p><strong>Hor√°rio:</strong> ${horario} | <strong>Itens:</strong> ${(comanda.itens || []).length}</p>
                    <p style="font-size: 0.8em; color: #ccc;">ID: ${comanda.id.substring(0, 8)}</p>
                `;
                container.appendChild(div);
            });
        }

        function selecionarComanda(comanda) {
            GLOBAL_COMANDA_ID = comanda.id;
            GLOBAL_ORDER_ITEMS = comanda.itens || [];
            GLOBAL_COMANDA_NOME = comanda.nome_comanda || 'Principal';
            document.getElementById('observacao').value = comanda.observacao || '';
            showPdvView(comanda.mesa);
        }

        async function criarNovaComanda() {
            const { data: newPedido, error } = await supabaseClient
                .from('pedidos')
                .insert({ 
                    mesa: GLOBAL_MESA_ID, 
                    status: 'Aberto', 
                    itens: [], 
                    total: 0,
                    nome_comanda: `Comanda ${GLOBAL_MESA_COMANDAS.length + 1}`,
                    horario: new Date().toISOString(),
                    data: new Date().toISOString().split('T')[0] 
                })
                .select()
                .single();

            if (error) {
                alert('Erro ao criar nova comanda!');
                console.error(error);
                return;
            }

            GLOBAL_COMANDA_ID = newPedido.id;
            GLOBAL_ORDER_ITEMS = [];
            GLOBAL_COMANDA_NOME = newPedido.nome_comanda;
            showPdvView(GLOBAL_MESA_ID);
        }

        function abrirNovaComandaNaMesmaMesa() {
            showComandaSelectionView();
        }

        // --- FUN√á√ÉO EDITAR NOME DA COMANDA ---

        function editarNomeComanda() {
            document.getElementById('novo-nome-comanda').value = GLOBAL_COMANDA_NOME;
            document.getElementById('modal-editar-nome').style.display = 'block';
        }

        function fecharModalEditarNome() {
            document.getElementById('modal-editar-nome').style.display = 'none';
        }

        async function salvarNomeComanda() {
            const novoNome = document.getElementById('novo-nome-comanda').value.trim();
            if (!novoNome) {
                alert('Digite um nome para a comanda!');
                return;
            }

            const { error } = await supabaseClient
                .from('pedidos')
                .update({ nome_comanda: novoNome })
                .eq('id', GLOBAL_COMANDA_ID);

            if (error) {
                alert('Erro ao atualizar nome da comanda!');
                console.error(error);
                return;
            }

            GLOBAL_COMANDA_NOME = novoNome;
            document.getElementById('comanda-nome-display').textContent = novoNome;
            fecharModalEditarNome();
            alert('Nome da comanda atualizado!');
        }

        // --- FUN√á√ïES DE AUTENTICA√á√ÉO ---

        async function fazerLogin() {
            const email = document.getElementById('email-login').value;
            const senha = document.getElementById('senha-login').value;

            if (!email || !senha) {
                alert('Por favor, preencha email e senha.');
                return;
            }

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: senha });

            if (error) {
                alert(`Erro no Login: ${error.message}`);
                console.error(error);
            } else {
                showMesasView();
            }
        }

        // --- FUN√á√ïES DE MESAS ---

        async function carregarMesas() {
            try {
                const { data, error } = await supabaseClient
                    .from('mesas_status')
                    .select('*')
                    .order('mesa', { ascending: true });

                if (error) {
                    console.error('Erro ao carregar mesas:', error);
                    updateStatusIndicator(false);
                    return;
                }

                const container = document.getElementById('mesas-view');
                container.innerHTML = '<h2>Escolha a Mesa</h2>';

                const mesasOrdenadas = data.sort((a, b) => parseInt(a.mesa) - parseInt(b.mesa));

                mesasOrdenadas.forEach(mesa => {
                    const mesaContainer = document.createElement('div');
                    mesaContainer.className = 'mesa-container';
                    
                    const button = document.createElement('button');
                    const statusClass = mesa.status.toLowerCase().replace(' ', '_');
                    button.className = `mesa-btn ${statusClass}`;
                    
                    // üÜï MOSTRAR STATUS NO TEXTO DO BOT√ÉO
                    button.textContent = `Mesa ${mesa.mesa}\n(${mesa.status})`;
                    button.onclick = () => abrirMesa(mesa.mesa, mesa.status, mesa.pedido_id);
                    
                    if (mesa.status !== 'Livre') {
                        const badge = document.createElement('div');
                        badge.className = 'badge-comandas';
                        badge.textContent = '1+';
                        mesaContainer.appendChild(badge);
                    }
                    
                    mesaContainer.appendChild(button);
                    container.appendChild(mesaContainer);
                });

                updateStatusIndicator(true);
            } catch (err) {
                console.error('Erro no polling:', err);
                updateStatusIndicator(false);
            }
        }

        async function abrirMesa(mesaId, status, pedidoId) {
            GLOBAL_MESA_ID = mesaId;
            
            if (status === 'Livre') {
                await criarPrimeiraComanda(mesaId);
            } else {
                showComandaSelectionView();
            }
        }

        async function criarPrimeiraComanda(mesaId) {
            const { data: newPedido, error: pedidoError } = await supabaseClient
                .from('pedidos')
                .insert({ 
                    mesa: mesaId, 
                    status: 'Aberto', 
                    itens: [], 
                    total: 0,
                    nome_comanda: 'Comanda Principal',
                    horario: new Date().toISOString(),
                    data: new Date().toISOString().split('T')[0] 
                })
                .select()
                .single();

            if (pedidoError) {
                alert('Erro ao criar nova comanda!');
                console.error('Erro ao criar comanda:', pedidoError);
                return;
            }

            GLOBAL_COMANDA_ID = newPedido.id;
            GLOBAL_ORDER_ITEMS = [];
            GLOBAL_COMANDA_NOME = 'Comanda Principal';

            const { error: mesaError } = await supabaseClient
                .from('mesas_status')
                .update({ status: 'Ocupada', pedido_id: newPedido.id })
                .eq('mesa', mesaId);

            if (mesaError) {
                console.error('Erro ao atualizar status da mesa:', mesaError);
            }

            showPdvView(mesaId);
        }

        // --- FUN√á√ïES DE CARD√ÅPIO E BUSCA ---

        async function carregarCardapio() {
            console.log('Carregando card√°pio...');
            
            const buscaInput = document.getElementById('busca-input');
            const buscaTermo = buscaInput ? buscaInput.value.toLowerCase().trim() : '';

            let query = supabaseClient.from('cardapio').select('*');
            
            if (buscaTermo) {
                query = query.ilike('nome_item', `%${buscaTermo}%`); 
            }

            const { data: itens, error } = await query
                .order('categoria', { ascending: true })
                .order('nome_item', { ascending: true });

            if (error) { 
                console.error('Erro ao carregar card√°pio:', error); 
                document.getElementById('cardapio-view').innerHTML = '<p style="color: #ff4444; padding: 20px; text-align: center;">Erro ao carregar card√°pio. Verifique a conex√£o.</p>';
                return; 
            }

            console.log('Itens carregados:', itens);

            const container = document.getElementById('cardapio-view');
            
            if (!itens || itens.length === 0) {
                container.innerHTML = '<p style="color: #ccc; padding: 20px; text-align: center;">Nenhum item encontrado no card√°pio.</p>';
                return;
            }

            container.innerHTML = '';

            let categorias = {};
            itens.forEach(item => {
                if (item.categoria && item.categoria.trim() !== '') {
                    if (!categorias[item.categoria]) categorias[item.categoria] = [];
                    categorias[item.categoria].push(item);
                }
            });

            if (Object.keys(categorias).length === 0) {
                itens.forEach(i => {
                    adicionarItemCardapio(container, i);
                });
            } else {
                for (const [categoria, itensCategoria] of Object.entries(categorias)) {
                    const h3 = document.createElement('h3');
                    h3.textContent = categoria;
                    h3.style.color = '#ff8c00';
                    h3.style.marginTop = '20px';
                    h3.style.marginBottom = '10px';
                    container.appendChild(h3);

                    itensCategoria.forEach(i => {
                        adicionarItemCardapio(container, i);
                    });
                }
            }
        }

        function adicionarItemCardapio(container, item) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-cardapio';
            const precoFormatado = parseFloat(item.preco).toFixed(2).replace('.', ','); 
            
            itemDiv.innerHTML = `
                <span class="item-info">${item.nome_item}</span> 
                <span class="item-preco">R$ ${precoFormatado}</span>
                <button class="add-btn" onclick="addToCommand(${item.id}, '${item.nome_item.replace(/'/g, "\\'")}', ${item.preco})">ADD</button>
            `;
            container.appendChild(itemDiv);
        }

        // --- FUN√á√ïES DE MANIPULA√á√ÉO DA COMANDA ---

        function addToCommand(id, nome, preco) {
            const itemIndex = GLOBAL_ORDER_ITEMS.findIndex(item => item.id === id);

            if (itemIndex > -1) {
                GLOBAL_ORDER_ITEMS[itemIndex].quantidade += 1;
            } else {
                GLOBAL_ORDER_ITEMS.push({ id, nome, preco, quantidade: 1 });
            }
            renderComanda();
        }

        function removeFromCommand(index) {
            GLOBAL_ORDER_ITEMS[index].quantidade -= 1;
            if (GLOBAL_ORDER_ITEMS[index].quantidade <= 0) {
                GLOBAL_ORDER_ITEMS.splice(index, 1);
            }
            renderComanda();
        }

        function renderComanda() {
            const lista = document.getElementById('itens-comanda');
            lista.innerHTML = '';
            let total = 0;

            GLOBAL_ORDER_ITEMS.forEach((item, index) => {
                const li = document.createElement('li');
                const subtotal = item.quantidade * item.preco;
                total += subtotal;

                const subtotalFormatado = subtotal.toFixed(2).replace('.', ',');

                li.innerHTML = `
                    <span>${item.quantidade}x ${item.nome}</span> 
                    <span>R$ ${subtotalFormatado} 
                        <button class="remover-btn" onclick="removeFromCommand(${index})">X</button>
                    </span>
                `;
                lista.appendChild(li);
            });

            document.getElementById('total-comanda').textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        // --- FUN√á√ïES DE ENVIO PARA COZINHA ---

        async function enviarParaCozinha() { 
            if (GLOBAL_ORDER_ITEMS.length === 0) {
                alert("N√£o h√° itens para enviar para cozinha.");
                return;
            }

            const totalComanda = parseFloat(document.getElementById('total-comanda').textContent.replace('Total: R$ ', '').replace(',', '.'));
            const observacao = document.getElementById('observacao').value.trim();

            // üÜï ATUALIZAR STATUS PARA "EM PREPARO"
            const { error: saveError } = await supabaseClient
                .from('pedidos')
                .update({ 
                    itens: GLOBAL_ORDER_ITEMS, 
                    observacao: observacao,
                    total: totalComanda,
                    status: 'Em Preparo'
                })
                .eq('id', GLOBAL_COMANDA_ID);

            if (saveError) {
                console.error('Erro ao enviar pedido para cozinha:', saveError);
                alert('Erro ao enviar pedido para a cozinha!');
                return;
            }

            // üÜï ATUALIZAR STATUS DA MESA
            const { error: mesaError } = await supabaseClient
                .from('mesas_status')
                .update({ status: 'Em Preparo' })
                .eq('mesa', GLOBAL_MESA_ID);

            if (mesaError) {
                console.error('Erro ao atualizar status da mesa:', mesaError);
            }

            // üÜï IMPRIMIR NA COZINHA (SEM ABRIR TELA DE IMPRESS√ÉO NO GAR√áOM)
            await imprimirNaCozinha();

            alert('Pedido enviado para cozinha com sucesso!');
            
            // üÜï VOLTAR PARA MESAS AP√ìS ENVIAR
            setTimeout(() => {
                showMesasView();
                carregarMesas();
            }, 1000);
        }

        // üÜï FUN√á√ÉO PARA IMPRIMIR NA COZINHA
async function imprimirNaCozinha() {
    const mesaId = GLOBAL_MESA_ID; 
    const total = document.getElementById('total-comanda').textContent;
    const dataHora = new Date().toLocaleString('pt-BR');
    const observacao = document.getElementById('observacao').value.trim();
    const nomeComanda = GLOBAL_COMANDA_NOME;
    
    let printContent = `
        <div style="font-family: monospace; font-size: 14pt; line-height: 1.4; color: #000000;">
            <h2 style="text-align: center; margin: 5px 0; font-size: 18pt; color: #000000;">
                <strong>ESPETINHO GESSELO</strong>
            </h2>
            <h3 style="text-align: center; margin: 0 0 10px 0; font-size: 16pt; color: #000000;">
                <strong>COMANDA - MESA ${mesaId}</strong>
            </h3>
            <p style="text-align: center; margin: 0 0 8px 0; font-size: 13pt; color: #000000;">
                <strong>${nomeComanda}</strong>
            </p>
            <p style="border-top: 2px solid #000; padding-top: 8px; margin-bottom: 10px; font-size: 12pt; color: #000000;">
                <strong>Data: ${dataHora}</strong>
            </p>
            
            <h4 style="font-size: 14pt; margin: 15px 0 8px 0; border-bottom: 2px solid #000; padding-bottom: 5px; color: #000000;">
                <strong>ITENS:</strong>
            </h4>
            <ul style="list-style: none; padding: 0; margin: 0;">
            ${GLOBAL_ORDER_ITEMS.map(item => `
                <li style="margin-bottom: 8px; font-size: 13pt; color: #000000; border-bottom: 1px dashed #000; padding-bottom: 4px;">
                    <strong>${item.quantidade}x ${item.nome}</strong>
                    <span style="float: right;">
                        <strong>R$ ${item.preco.toFixed(2).replace('.', ',')}</strong>
                    </span>
                </li>
            `).join('')}
            </ul>
            
            ${observacao ? `
                <div style="border-top: 2px solid #000; padding-top: 10px; margin-top: 15px;">
                    <p style="font-size: 12pt; margin: 8px 0; color: #000000;">
                        <strong>OBS: ${observacao}</strong>
                    </p>
                </div>
            ` : ''}
            
            <h3 style="border-top: 3px solid #000; padding-top: 12px; margin-top: 20px; text-align: right; font-size: 16pt; color: #000000;">
                <strong>${total}</strong>
            </h3>
        </div>
    `;

    // üÜï ENVIAR PARA IMPRESSORA DA COZINHA VIA SUPABASE
    const { error } = await supabaseClient
        .from('impressoes_cozinha')
        .insert({
            mesa: mesaId,
            comanda_nome: nomeComanda,
            conteudo: printContent,
            itens: GLOBAL_ORDER_ITEMS,
            total: total,
            observacao: observacao,
            data_hora: new Date().toISOString()
        });

    if (error) {
        console.error('Erro ao enviar para impress√£o na cozinha:', error);
        // Fallback: salvar em localStorage para a cozinha ler
        localStorage.setItem('ultima_impressao_cozinha', JSON.stringify({
            mesa: mesaId,
            comanda_nome: nomeComanda,
            conteudo: printContent,
            data_hora: new Date().toISOString()
        }));
    }
}

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('Usu√°rio logado, mostrando mesas...');
                    showMesasView();
                    
                    setTimeout(() => {
                        console.log('Testando carregamento do card√°pio...');
                        carregarCardapio().then(() => {
                            console.log('Card√°pio carregado com sucesso!');
                        }).catch(error => {
                            console.error('Erro ao carregar card√°pio:', error);
                        });
                    }, 1000);
                    
                } else {
                    console.log('Usu√°rio n√£o logado, mostrando login...');
                    showLoginView();
                }
            });
        });

        window.onclick = function(event) {
            const modal = document.getElementById('modal-editar-nome');
            if (event.target === modal) {
                fecharModalEditarNome();
            }
        }
    </script>
</body>
</html>
