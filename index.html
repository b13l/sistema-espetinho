<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Espetinho Gesselo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #1a1a1a; color: white; margin: 0; padding: 0; }
        .container { max-width: 1000px; margin: 50px auto; padding: 20px; background-color: #2c2c2c; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
        .header { text-align: center; margin-bottom: 30px; }
        
        #login-view { text-align: center; padding: 50px; }
        #login-view input { padding: 10px; margin: 10px 0; width: 80%; max-width: 300px; border: none; border-radius: 4px; }
        #login-view button { padding: 10px 20px; background-color: #ff8c00; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }

        #mesas-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; text-align: center; }
        .mesa-btn { padding: 30px 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: background-color 0.2s; position: relative; }
        .mesa-btn.livre { background-color: #4CAF50; color: white; }
        .mesa-btn.ocupada { background-color: #FF5733; color: white; }
        .mesa-btn.em_preparo { background-color: #FFC300; color: black; }
        .mesa-btn.pronto { background-color: #00bcd4; color: white; }
        .mesa-badge { position: absolute; top: 5px; right: 5px; background-color: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        
        #pdv-view { display: flex; gap: 20px; }
        .cardapio-col { flex: 2; overflow-y: auto; max-height: 80vh; padding-right: 10px; }
        .comanda-col { flex: 1; background-color: #383838; padding: 15px; border-radius: 8px; }
        
        .item-cardapio { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #555; }
        .item-cardapio:last-child { border-bottom: none; }
        .item-info { flex-grow: 1; }
        .item-preco { font-weight: bold; margin-right: 10px; color: #ff8c00; }
        .add-btn { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        #itens-comanda { list-style: none; padding: 0; margin: 10px 0; }
        #itens-comanda li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #555; }
        .remover-btn { background-color: #FF5733; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; margin-left: 5px; }
        
        #total-comanda { font-size: 1.2em; font-weight: bold; margin-top: 15px; border-top: 2px solid #555; padding-top: 10px; }
        #observacao { width: 95%; padding: 10px; border-radius: 4px; border: 1px solid #555; background-color: #444; color: white; margin-bottom: 15px; }
        
        .action-buttons button { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.1em; }
        .enviar-btn { background-color: #007bff; color: white; }
        .enviar-btn:hover { background-color: #0056b3; }

        .status-indicator { position: fixed; top: 10px; right: 10px; padding: 5px 10px; background-color: #4CAF50; color: white; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>

    <div class="status-indicator" id="status-indicator">●</div>

    <div class="container">
        <div class="header">
            <h1 style="color: #ff8c00;">PDV Espetinho Gesselo</h1>
        </div>

        <div id="login-view">
            <h2>Login</h2>
            <input type="email" id="email-login" placeholder="Email" value="admin@gesselo.com">
            <input type="password" id="senha-login" placeholder="Senha" value="123456">
            <button onclick="fazerLogin()">Entrar</button>
        </div>

        <div id="mesas-view" style="display:none;">
        </div>

        <div id="pdv-view" style="display:none;">
        </div>
    </div>

    <script>

        const SUPABASE_URL = 'https://ufxbltjyswbynwnaybev.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmeGJsdGp5c3dieW53bmF5YmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjA3ODksImV4cCI6MjA3NDkzNjc4OX0.Ii4cIbNkUhbQ0T_C9WOXk15RveVI4YzbQ2eXUKMs9kc';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storageKey: 'supabase_auth_gesselo',
                persistSession: true,
                autoRefreshToken: true
            }
        });
        
        let GLOBAL_MESA_ID = null;
        let GLOBAL_COMANDA_ID = null;
        let GLOBAL_ORDER_ITEMS = [];
        let GLOBAL_COMANDAS_DA_MESA = [];
        
        let pollingInterval = null;
        const POLLING_INTERVAL_MS = 2000;

        function showLoginView() {
            stopPolling();
            document.getElementById('login-view').style.display = 'block';
            document.getElementById('mesas-view').style.display = 'none';
            document.getElementById('pdv-view').style.display = 'none';
        }

        function showMesasView() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('mesas-view').style.display = 'grid';
            document.getElementById('pdv-view').style.display = 'none';
            document.getElementById('pdv-view').innerHTML = ''; // Limpar PDV
            document.getElementById('mesas-view').innerHTML = '<h2 style="grid-column: 1 / -1; text-align: center; color: #ff8c00;">Escolha a Mesa</h2>';
            carregarMesas();
            startPolling();
        }

        function showPdvView(mesaId) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('mesas-view').style.display = 'none';
            const pdvView = document.getElementById('pdv-view');
            pdvView.style.display = 'flex';
            
            const numComandas = GLOBAL_COMANDAS_DA_MESA.length;
            const comandaAtualIdx = GLOBAL_COMANDAS_DA_MESA.findIndex(c => c.id === GLOBAL_COMANDA_ID);
            
            pdvView.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button onclick="voltarSelecaoComanda()" style="background-color: #555; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                        ← Voltar
                    </button>
                    <span style="font-size: 1.5em; color: #ff8c00;">
                        Mesa ${mesaId} - Comanda #${comandaAtualIdx + 1}
                    </span>
                </div>
                
                <div style="display: flex; gap: 20px;">
                    <div class="cardapio-col">
                        <input type="text" id="busca-input" placeholder="Buscar no Cardapio..." onkeyup="carregarCardapio()" style="width: 95%; padding: 10px; margin-bottom: 15px; background-color: #444; color: white; border: 1px solid #555; border-radius: 4px;">
                        <div id="cardapio-view"></div>
                    </div>

                    <div class="comanda-col">
                        <h3>Comanda Atual</h3>
                        <ul id="itens-comanda"></ul>
                        <div id="total-comanda">Total: R$ 0,00</div>
                        
                        <h4>Observacao da Comanda</h4>
                        <textarea id="observacao" placeholder="Ex: Sem pimenta, pouca cebola..."></textarea>
                        
                        <div class="action-buttons">
                            <button class="enviar-btn" onclick="enviarComandaParaCozinha()">Enviar Comanda para Cozinha</button>
                        </div>
                    </div>
                </div>
            `;
            
            carregarCardapio();
            renderComanda();
        }

        function voltarSelecaoComanda() {
            selecionarMesa(GLOBAL_MESA_ID);
        }

        function startPolling() {
            if (pollingInterval) return;
            
            pollingInterval = setInterval(async () => {
                await carregarMesas();
                updateStatusIndicator(true);
            }, POLLING_INTERVAL_MS);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function updateStatusIndicator(success) {
            const indicator = document.getElementById('status-indicator');
            if (success) {
                indicator.style.backgroundColor = '#4CAF50';
                indicator.textContent = '●';
            } else {
                indicator.style.backgroundColor = '#FF5733';
                indicator.textContent = '⚠';
            }
        }

        async function fazerLogin() {
            const email = document.getElementById('email-login').value;
            const senha = document.getElementById('senha-login').value;

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: senha });

            if (error) {
                alert(`Erro no Login: ${error.message}`);
                console.error(error);
            } else {
                alert('Login bem-sucedido!');
                showMesasView();
            }
        }

        async function carregarMesas() {
            try {
                const { data, error } = await supabaseClient
                    .from('mesas_status')
                    .select('*')
                    .order('mesa', { ascending: true });

                if (error) {
                    console.error('Erro ao carregar mesas:', error);
                    updateStatusIndicator(false);
                    return;
                }

                const { data: comandas } = await supabaseClient
                    .from('pedidos')
                    .select('mesa, id')
                    .in('status', ['Aberto', 'Em Preparo', 'Pronto']);

                const comandasPorMesa = {};
                if (comandas) {
                    comandas.forEach(c => {
                        if (!comandasPorMesa[c.mesa]) comandasPorMesa[c.mesa] = 0;
                        comandasPorMesa[c.mesa]++;
                    });
                }

                const container = document.getElementById('mesas-view');
                
                // Limpar apenas os botões, manter o título
                const botoesMesas = container.querySelectorAll('.mesa-btn');
                botoesMesas.forEach(btn => btn.remove());

                // Ordenar mesas numericamente
                const mesasOrdenadas = data.sort((a, b) => parseInt(a.mesa) - parseInt(b.mesa));

                mesasOrdenadas.forEach(mesa => {
                    const button = document.createElement('button');
                    const statusClass = mesa.status.toLowerCase().replace(' ', '_');
                    button.className = `mesa-btn ${statusClass}`;
                    
                    const numComandas = comandasPorMesa[mesa.mesa] || 0;
                    const badgeHTML = numComandas > 0 ? `<span class="mesa-badge">${numComandas}</span>` : '';
                    
                    button.innerHTML = `${badgeHTML}Mesa ${mesa.mesa}<br><small>(${mesa.status})</small>`;
                    button.onclick = () => selecionarMesa(mesa.mesa);
                    container.appendChild(button);
                });

                updateStatusIndicator(true);
            } catch (err) {
                console.error('Erro no polling:', err);
                updateStatusIndicator(false);
            }
        }

        async function selecionarMesa(mesaId) {
            GLOBAL_MESA_ID = mesaId;
            
            const { data: comandas, error } = await supabaseClient
                .from('pedidos')
                .select('*')
                .eq('mesa', mesaId)
                .in('status', ['Aberto', 'Em Preparo', 'Pronto'])
                .order('horario', { ascending: false });

            if (error) {
                console.error('Erro ao buscar comandas:', error);
            }

            GLOBAL_COMANDAS_DA_MESA = comandas || [];
            
            // SEMPRE mostrar a tela de seleção, mesmo sem comandas
            mostrarSelecaoComanda();
        }

        function mostrarSelecaoComanda() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('mesas-view').style.display = 'none';
            const pdvView = document.getElementById('pdv-view');
            pdvView.style.display = 'flex';
            
            pdvView.innerHTML = `
                <div style="width: 100%; background-color: #2c2c2c; padding: 30px; border-radius: 8px;">
                    <button onclick="showMesasView()" style="background-color: #555; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 20px;">← Voltar para Mesas</button>
                    <h2 style="color: #ff8c00; margin-bottom: 20px;">Mesa ${GLOBAL_MESA_ID} - Selecione ou Crie uma Comanda</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        ${GLOBAL_COMANDAS_DA_MESA.map((comanda, idx) => {
                            const totalItens = (comanda.itens || []).reduce((sum, i) => sum + i.quantidade, 0);
                            return `
                                <button onclick="abrirComanda('${comanda.id}')" 
                                        style="padding: 20px; background-color: #383838; border: 2px solid #ff8c00; border-radius: 8px; cursor: pointer; text-align: left; color: white; font-family: Arial;">
                                    <h3 style="color: #ff8c00; margin: 0 0 10px 0;">Comanda #${idx + 1}</h3>
                                    <p style="margin: 5px 0;">Total: <strong>R$ ${(comanda.total || 0).toFixed(2)}</strong></p>
                                    <p style="margin: 5px 0; color: #aaa; font-size: 0.9em;">${totalItens} itens</p>
                                    <p style="margin: 5px 0; color: #aaa; font-size: 0.9em;">Status: ${comanda.status}</p>
                                </button>
                            `;
                        }).join('')}
                        
                        <button onclick="criarNovaComanda(${GLOBAL_MESA_ID})" 
                                style="padding: 20px; background-color: #4CAF50; border: none; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; color: white; font-size: 1.1em;">
                            ➕ Nova Comanda
                        </button>
                    </div>
                </div>
            `;
        }

        async function criarNovaComanda(mesaId) {
            const { data: newPedido, error: pedidoError } = await supabaseClient
                .from('pedidos')
                .insert({ 
                    mesa: mesaId, 
                    status: 'Aberto', 
                    itens: [], 
                    total: 0,
                    horario: new Date().toISOString(),
                    data: new Date().toISOString().split('T')[0] 
                })
                .select()
                .single();

            if (pedidoError) {
                alert('Erro ao criar nova comanda!');
                console.error('Erro ao criar comanda:', pedidoError);
                return;
            }

            GLOBAL_COMANDA_ID = newPedido.id;
            GLOBAL_ORDER_ITEMS = [];

            const { error: mesaError } = await supabaseClient
                .from('mesas_status')
                .update({ status: 'Ocupada', pedido_id: newPedido.id })
                .eq('mesa', mesaId);

            if (mesaError) {
                console.error('Erro ao atualizar status da mesa:', mesaError);
            }
            
            // Recarregar as comandas da mesa
            await selecionarMesa(mesaId);
            
            // Abrir a nova comanda
            abrirComanda(newPedido.id);
        }

        async function abrirComanda(comandaId) {
            GLOBAL_COMANDA_ID = comandaId;

            const { data: pedido, error: fetchError } = await supabaseClient
                .from('pedidos')
                .select('itens, observacao')
                .eq('id', comandaId)
                .single();

            if (fetchError || !pedido) {
                alert('Erro ao carregar comanda existente!');
                console.error('Erro ao buscar comanda:', fetchError);
                return;
            }

            GLOBAL_ORDER_ITEMS = pedido.itens || [];

            showPdvView(GLOBAL_MESA_ID);
            
            // Atualizar observação depois que o elemento existir
            setTimeout(() => {
                const obsTextarea = document.getElementById('observacao');
                if (obsTextarea) {
                    obsTextarea.value = pedido.observacao || '';
                }
            }, 100);
        }

        async function carregarCardapio() {
            const buscaInput = document.getElementById('busca-input');
            const buscaTermo = buscaInput ? buscaInput.value.toLowerCase().trim() : '';

            let query = supabaseClient.from('cardapio').select('*');
            
            if (buscaTermo) {
                query = query.ilike('nome_item', `%${buscaTermo}%`); 
            }

            const { data: itens, error } = await query
                .order('categoria', { ascending: true })
                .order('nome_item', { ascending: true });

            if (error) { 
                console.error('Erro ao carregar cardapio:', error); 
                document.getElementById('cardapio-view').innerHTML = '<p class="error">Erro ao carregar cardapio.</p>';
                return; 
            }

            const container = document.getElementById('cardapio-view');
            container.innerHTML = '';

            let categorias = {};
            itens.forEach(item => {
                if (item.categoria && item.categoria.trim() !== '') {
                    if (!categorias[item.categoria]) categorias[item.categoria] = [];
                    categorias[item.categoria].push(item);
                }
            });

            for (const [categoria, itensCategoria] of Object.entries(categorias)) {
                const h3 = document.createElement('h3');
                h3.textContent = categoria;
                container.appendChild(h3);

                itensCategoria.forEach(i => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-cardapio';
                    const precoFormatado = parseFloat(i.preco).toFixed(2).replace('.', ','); 
                    
                    itemDiv.innerHTML = `
                        <span class="item-info">${i.nome_item}</span> 
                        <span class="item-preco">R$ ${precoFormatado}</span>
                        <button class="add-btn" onclick="addToCommand(${i.id}, '${i.nome_item.replace(/'/g, "\\'")}', ${i.preco})">ADD</button>
                    `;
                    container.appendChild(itemDiv);
                });
            }
        }

        function addToCommand(id, nome, preco) {
            const itemIndex = GLOBAL_ORDER_ITEMS.findIndex(item => item.id === id);

            if (itemIndex > -1) {
                GLOBAL_ORDER_ITEMS[itemIndex].quantidade += 1;
            } else {
                GLOBAL_ORDER_ITEMS.push({ id, nome, preco, quantidade: 1 });
            }
            renderComanda();
        }

        function removeFromCommand(index) {
            GLOBAL_ORDER_ITEMS[index].quantidade -= 1;
            if (GLOBAL_ORDER_ITEMS[index].quantidade <= 0) {
                GLOBAL_ORDER_ITEMS.splice(index, 1);
            }
            renderComanda();
        }

        function renderComanda() {
            const lista = document.getElementById('itens-comanda');
            lista.innerHTML = '';
            let total = 0;

            GLOBAL_ORDER_ITEMS.forEach((item, index) => {
                const li = document.createElement('li');
                const subtotal = item.quantidade * item.preco;
                total += subtotal;

                const subtotalFormatado = subtotal.toFixed(2).replace('.', ',');

                li.innerHTML = `
                    <span>${item.quantidade}x ${item.nome}</span> 
                    <span>R$ ${subtotalFormatado} 
                        <button class="remover-btn" onclick="removeFromCommand(${index})">X</button>
                    </span>
                `;
                lista.appendChild(li);
            });

            document.getElementById('total-comanda').textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        async function enviarComandaParaCozinha() { 
            if (GLOBAL_ORDER_ITEMS.length === 0) {
                alert("Nao ha itens para enviar.");
                return;
            }

            const totalComanda = parseFloat(document.getElementById('total-comanda').textContent.replace('Total: R$ ', '').replace(',', '.'));
            const observacao = document.getElementById('observacao').value.trim();

            const { error: saveError } = await supabaseClient
                .from('pedidos')
                .update({ 
                    itens: GLOBAL_ORDER_ITEMS, 
                    observacao: observacao,
                    total: totalComanda,
                    status: 'Em Preparo' 
                })
                .eq('id', GLOBAL_COMANDA_ID);

            if (saveError) {
                console.error('Erro ao salvar o pedido:', saveError);
                alert('Erro ao enviar pedido para a cozinha!');
                return;
            }

            const { error: mesaError } = await supabaseClient
                .from('mesas_status')
                .update({ status: 'Em Preparo' })
                .eq('mesa', GLOBAL_MESA_ID);

            if (mesaError) {
                console.error('Erro ao atualizar status da mesa:', mesaError);
            }

            alert(`✓ Comanda da Mesa ${GLOBAL_MESA_ID} enviada para a cozinha com sucesso!`);
            showMesasView();
        }

        document.addEventListener('DOMContentLoaded', () => {
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    showMesasView();
                } else {
                    showLoginView();
                }
            });
        });
    </script>
</body>
</html>
