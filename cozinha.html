<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozinha e Gerenciamento</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <audio id="alertSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #1a1a1a; color: white; margin: 0; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        
        /* PEDIDOS DA COZINHA */
        #pedidos-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .pedido-card { background-color: #383838; padding: 15px; border-radius: 8px; width: 320px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); }
        .pedido-card h3 { color: #ff8c00; margin-top: 0; border-bottom: 2px solid #555; padding-bottom: 5px; }
        .lista-itens { list-style: none; padding: 0; margin: 10px 0; }
        .lista-itens li { padding: 3px 0; border-bottom: 1px dotted #555; font-size: 0.9em; }
        .pedido-card button { width: 100%; padding: 10px; color: white; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        .btn-pronto { background-color: #4CAF50; }
        .btn-fechar-conta { background-color: #007bff; margin-top: 5px; }
        
        /* MESAS EM GRID */
        .mesas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-bottom: 30px; }
        .mesa-item { padding: 25px 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; text-align: center; transition: all 0.3s; position: relative; }
        .mesa-item.livre { background-color: #4CAF50; color: white; }
        .mesa-item.ocupada { background-color: #FF5733; color: white; }
        .mesa-item.em_preparo { background-color: #FFC300; color: black; }
        .mesa-item.pronto { background-color: #00bcd4; color: white; }
        .mesa-item:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        
        /* CAIXA E GERENCIAMENTO */
        .gerenciamento-col { background-color: #2c2c2c; padding: 20px; border-radius: 8px; }
        #caixa-do-dia { margin-top: 20px; padding: 15px; border: 1px solid #ff8c00; border-radius: 4px; }
        #caixa-do-dia h4 { color: #ff8c00; }
        .caixa-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-caixa { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-baixar-pdf { background-color: #28a745; color: white; }
        .btn-limpar-caixa { background-color: #dc3545; color: white; }
        .btn-baixar-pdf:hover { background-color: #218838; }
        .btn-limpar-caixa:hover { background-color: #c82333; }
        
        /* ADICIONAR ITEM */
        .adicionar-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #555; }
        .mesa-selecionada-info { background-color: #ff8c00; padding: 10px; border-radius: 4px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .comanda-selecionada-info { background-color: #4CAF50; padding: 8px; border-radius: 4px; margin-bottom: 10px; text-align: center; font-size: 0.9em; }
        .item-cardapio { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background-color: #383838; border-radius: 4px; }
        .item-info { flex-grow: 1; }
        .item-preco { font-weight: bold; margin-right: 10px; color: #ff8c00; }
        .add-btn { background-color: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        /* INDICADORES */
        .status-indicator { position: fixed; top: 10px; right: 10px; padding: 8px 12px; background-color: #4CAF50; color: white; border-radius: 4px; font-size: 0.9em; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1000; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        /* ALERTA SONORO */
        .alert-indicator { position: fixed; top: 10px; left: 10px; padding: 8px 12px; background-color: #ff8c00; color: white; border-radius: 4px; font-size: 0.9em; display: none; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1000; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
        
        /* MODAIS */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); overflow-y: auto; }
        .modal-content { background-color: #2c2c2c; margin: 3% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; max-height: 85vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
        .close:hover { color: white; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 4px; border: 1px solid #555; background-color: #444; color: white; box-sizing: border-box; }
        .modal-content label { display: block; margin-top: 10px; font-weight: bold; color: #ff8c00; }
        .btn-confirmar { width: 100%; padding: 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        .troco-display { background-color: #383838; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4CAF50; }
        .troco-display h3 { color: #4CAF50; margin: 0 0 10px 0; }
        
        /* NOVO: MODAIS FECHAR CAIXA E DESBLOQUEIO */
        #modal-fechar-caixa .modal-content, #modal-desbloqueio .modal-content { max-width: 500px; }
        
        /* NOVO: SELEÇÃO DE COMANDA */
        .comanda-option { background: #383838; margin: 5px 0; padding: 10px; border-radius: 4px; cursor: pointer; border: 1px solid #555; }
        .comanda-option:hover { border-color: #ff8c00; }
        .comanda-option.selecionada { border-color: #4CAF50; background: #2d4a2d; }
        
        /* NOVO: ESTILOS PARA OS BOTÕES DE BLOQUEIO/DESBLOQUEIO */
        #btn-bloquear-caixa { background-color: #6c757d; color: white; margin-top: 15px; }
        #btn-desbloquear-caixa { background-color: #ffc107; color: black; margin-top: 15px; }
        
        /* NOVO: CLASSE DE BLUR */
        .blurry {
            filter: blur(5px);
            user-select: none;
            pointer-events: none;
            transition: filter 0.5s;
        }

        @media print {
            body > *:not(#comanda-impressao) { display: none !important; }
            #comanda-impressao { display: block !important; width: 80mm; margin: 0 auto; }
            @page { margin: 0; padding: 0; size: 80mm auto; }
        }
    </style>
</head>
<body onload="initCozinha();">
    <div class="status-indicator" id="status-indicator"><div class="status-dot"></div><span>Conectado</span></div>
    <div class="alert-indicator" id="alert-indicator"><div class="status-dot"></div><span>🔔 Novo Pedido!</span></div>
    
    <div class="header"><h1 style="color: #4CAF50;">Painel de Gerenciamento - Cozinha & Caixa</h1></div>
    
    <div class="grid-container">
        <div>
            <h2>📦 Pedidos - Cozinha</h2>
            <div id="pedidos-container"><p style="text-align: center;">Carregando pedidos...</p></div>
        </div>
        
        <div class="gerenciamento-col">
            <h2>💰 Caixa do Dia</h2>
            <div id="caixa-do-dia">
                <div id="caixa-content">
                    <p>Total Fechado Hoje: <strong id="total-caixa">R$ 0,00</strong></p>
                    <p>Número de Pedidos: <strong id="contagem-pedidos">0</strong></p>
                    <div id="totais-por-forma"></div>
                </div>
            </div>
            
            <div class="caixa-actions" id="caixa-actions-container">
                <button class="btn-caixa btn-baixar-pdf" onclick="baixarCaixaPDF()">📥 Baixar PDF</button>
                <button class="btn-caixa btn-limpar-caixa" onclick="limparCaixaDoDia()">🗑️ Limpar Caixa</button>
            </div>
            
            <button class="btn-caixa" id="btn-fechar-caixa" style="width: 100%; margin-top: 15px; background-color: #007bff; color: white;" onclick="abrirModalFechamentoCaixa()">💰 Fechar Caixa do Dia</button>
            <button class="btn-caixa" id="btn-bloquear-caixa" style="width: 100%;" onclick="bloquearCaixaManualmente()">🔒 Bloquear Caixa</button>
            <button class="btn-caixa" id="btn-desbloquear-caixa" style="width: 100%; display: none;" onclick="abrirModalDesbloqueio()">🔓 Desbloquear Caixa (Senha)</button>
        </div>
    </div>
    
    <hr style="margin: 40px 0; border-color: #555;">
    
    <div class="grid-container">
        <div>
            <h2>📋 Status das Mesas</h2>
            <div class="mesas-grid" id="mesas-grid"></div>
        </div>
        
        <div class="gerenciamento-col adicionar-section">
            <h2>➕ Adicionar Item na Mesa</h2>
            <div id="mesa-selecionada-info" style="display: none;" class="mesa-selecionada-info"></div>
            <div id="comanda-selecionada-info" style="display: none;" class="comanda-selecionada-info"></div>
            <div id="selecao-comandas" style="display: none; margin-bottom: 15px;"></div>
            <div id="adicional-cardapio-container"></div>
        </div>
    </div>
    
<div id="modal-fechar-conta" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalConta()">&times;</span>
        <h2 style="color: #ff8c00;">Fechar Conta - Mesa <span id="modal-mesa-num"></span></h2>
        <div id="modal-itens-lista"></div>
        <h3 style="color: #4CAF50; margin-top: 20px;">Subtotal: R$ <span id="modal-subtotal">0,00</span></h3>
        <!-- 🔽🔽🔽 AQUI: TAXA DE SERVIÇO NO MODAL COM FONTE PEQUENA -->
        <h3 style="color: #ffc107; font-size: 12px; margin: 5px 0;">Taxa de Serviço (10%): R$ <span id="modal-taxa-servico">0,00</span></h3>
        <h2 style="color: #4CAF50;">Total a Pagar: R$ <span id="modal-total">0,00</span></h2>
            <label>Forma de Pagamento:</label>
            <select id="modal-forma-pagamento">
                <option value="">Selecione...</option>
                <option value="Cartao Debito">Cartão Débito</option>
                <option value="Cartao Credito">Cartão Crédito</option>
                
            </select>
            <div id="campo-dinheiro" style="display: none;">
                <label>Valor Recebido:</label>
                <input type="number" id="valor-recebido" step="0.01" placeholder="Ex: 50.00" oninput="calcularTroco()">
                <div id="troco-info" style="display: none;" class="troco-display">
                    <h3>Troco: R$ <span id="valor-troco">0,00</span></h3>
                </div>
            </div>
            <button class="btn-confirmar" onclick="confirmarFechamentoConta()">Confirmar e Imprimir</button>
        </div>
    </div>
    
    <div id="modal-fechar-caixa" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalFecharCaixa()">&times;</span>
            <h2 style="color: #ff8c00;">Fechar Caixa do Dia</h2>
            <div id="resumo-caixa"></div>
            <button class="btn-confirmar" onclick="confirmarFechamentoCaixa()">Confirmar Fechamento</button>
        </div>
    </div>

    <div id="modal-desbloqueio" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close" onclick="fecharModalDesbloqueio()">&times;</span>
            <h2 style="color: #ffc107;">Desbloqueio de Caixa</h2>
            <p>Insira a senha para liberar as ações do caixa.</p>
            <label for="input-senha-desbloqueio" style="margin-top: 20px;">Senha:</label>
            <input type="password" id="input-senha-desbloqueio" placeholder="Digite a senha de desbloqueio" required>
            <button class="btn-confirmar" style="background-color: #ffc107; color: black;" onclick="verificarSenhaDesbloqueio()">Desbloquear</button>
            <p id="mensagem-erro-desbloqueio" style="color: #dc3545; margin-top: 10px; display: none;">Senha incorreta. Tente novamente.</p>
        </div>
    </div>
    
    <div id="comanda-impressao" style="display:none;"></div>
    
    <script>
        const SUPABASE_URL='https://ufxbltjyswbynwnaybev.supabase.co';
        const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmeGJsdGp5c3dieW53bmF5YmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjA3ODksImV4cCI6MjA3NDkzNjc4OX0.Ii4cIbNkUhbQ0T_C9WOXk15RveVI4YzbQ2eXUKMs9kc';
        const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
        
        // ⚠️ MUDE ESTA SENHA PARA ALGO SEGURO!
        const SENHA_DESBLOQUEIO = '888888'; 
        
        let pedidosAtuais=[],mesasStatus=[],cardapioItens=[],pedidoAtualModal=null,mesaSelecionadaAdicionar=null;
        let pollingIntervalPedidos=null,pollingIntervalMesas=null,pollingIntervalCaixa=null;
        
        let ultimaImpressaoTimestamp = null;
        let impressaoInterval = null;
        let impressoesProcessadas = new Set();
        let isPrinting = false;
        
        let comandasDaMesaSelecionada = [];
        let comandaSelecionadaParaAdicionar = null;

        let totalCom10Percent = 0;
        let taxaServico = 0;
        // 🆕 INICIA SEMPRE BLOQUEADO AO CARREGAR A PÁGINA
        let caixaFechadaHoje = true; 
        
        function initCozinha(){
            startAllPolling();
            iniciarImpressaoAutomatica();
            calcularCaixaDoDia();
            
            // 🆕 Configura o evento 'Enter' para o modal de desbloqueio
            document.getElementById('input-senha-desbloqueio').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarSenhaDesbloqueio();
                }
            });
            
            // 🆕 Aplica o estado inicial de bloqueio/blur
            updateCaixaBlockStatus();

            ultimaImpressaoTimestamp = new Date().toISOString();
            console.log('Cozinha iniciada - Só processará impressões após:', ultimaImpressaoTimestamp);
        }
        
        function startAllPolling(){
            // Garante que o polling não rode duplicado
            if (pollingIntervalPedidos) return; 

            fetchPedidos();
            pollingIntervalPedidos=setInterval(fetchPedidos,3000);
            fetchMesas();
            pollingIntervalMesas=setInterval(fetchMesas,3000);
            calcularCaixaDoDia();
            pollingIntervalCaixa=setInterval(calcularCaixaDoDia,5000);
            updateStatusIndicator(true);
        }
        
        function updateStatusIndicator(success){
            const indicator=document.getElementById('status-indicator');
            if(success){
                indicator.style.backgroundColor='#4CAF50';
            }else{
                indicator.style.backgroundColor='#FF5733';
            }
        }
        
        function tocarAlertaSonoro() {
            try {
                const audio = document.getElementById('alertSound');
                audio.volume = 0.7;
                audio.play().catch(e => console.log('Erro ao tocar áudio:', e));
                
                const alertIndicator = document.getElementById('alert-indicator');
                alertIndicator.style.display = 'flex';
                setTimeout(() => {
                    alertIndicator.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.log('Erro no alerta sonoro:', error);
            }
        }
        
        async function fetchPedidos(){
            try{
                const{data,error}=await supabaseClient.from('pedidos').select('*').neq('status','Fechado').order('horario', { ascending: true });
                if(error)throw error;
                
                const tinhaPedidos = pedidosAtuais.length > 0;
                const novosPedidos = data.filter(newPedido => 
                    !pedidosAtuais.some(oldPedido => oldPedido.id === newPedido.id)
                );
                
                pedidosAtuais=data;
                renderPedidos();
                updateStatusIndicator(true);
                
                if (tinhaPedidos && novosPedidos.length > 0) {
                    tocarAlertaSonoro();
                }
            }catch(err){
                console.error('Erro:',err);
                updateStatusIndicator(false);
            }
        }
        
        function renderPedidos(){
            const container=document.getElementById('pedidos-container');
            const pedidosAbertos=pedidosAtuais.filter(p=>p.status==='Aberto'||p.status==='Em Preparo'||p.status==='Pronto');
            container.innerHTML='';
            if(pedidosAbertos.length===0){
                container.innerHTML='<p style="color:gray;text-align:center;">Nenhum pedido em preparo.</p>';
                return;
            }
            pedidosAbertos.forEach(pedido=>{
                const div=document.createElement('div');
                div.className='pedido-card';
                const listaItens=(pedido.itens||[]).map(item=>`<li>${item.quantidade}x ${item.nome}</li>`).join('');
                const statusColor=pedido.status==='Pronto'?'lime':(pedido.status==='Em Preparo'?'yellow':'red');
                
                const horario = pedido.horario ? new Date(pedido.horario).toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '--:--';
                
                const nomeComanda = pedido.nome_comanda || 'Comanda Principal';
                
                div.innerHTML=`
                    <h3>Mesa ${pedido.mesa} - ${nomeComanda} - #${pedido.id.substring(0,4)}</h3>
                    <p><strong>Horário:</strong> ${horario}</p>
                    <p><strong>Status:</strong> <strong style="color:${statusColor};">${pedido.status}</strong></p>
                    <p><strong>Total:</strong> R$ ${(pedido.total||0).toFixed(2).replace('.',',')}</p>
                    <p><strong>Obs:</strong> ${pedido.observacao||'Nenhuma'}</p>
                    <ul class="lista-itens">${listaItens}</ul>
                    <button class="btn-pronto" onclick="marcarComoPronto('${pedido.id}','${pedido.mesa}')" ${pedido.status==='Pronto'?'disabled':''}>${pedido.status==='Pronto'?'✓ PRONTO':'Marcar Pronto'}</button>
                    <button class="btn-fechar-conta" onclick="abrirModalFecharConta('${pedido.id}')">Fechar Conta</button>
                `;
                container.appendChild(div);
            });
        }
        
        async function marcarComoPronto(pedidoId,mesaId){
            await supabaseClient.from('pedidos').update({status:'Pronto'}).eq('id',pedidoId);
            await supabaseClient.from('mesas_status').update({status:'Pronto'}).eq('mesa',mesaId);
            fetchPedidos();
            fetchMesas();
        }
        
        async function fetchMesas(){
            try{
                const{data,error}=await supabaseClient.from('mesas_status').select('*').order('mesa',{ascending:true});
                if(error)throw error;
                mesasStatus=data||[];
                renderMesas();
            }catch(err){
                console.error('Erro:',err);
            }
        }
        
        function renderMesas(){
            const container=document.getElementById('mesas-grid');
            container.innerHTML='';
            
            const mesasOrdenadas=mesasStatus.sort((a,b)=>parseInt(a.mesa)-parseInt(b.mesa));
            
            mesasOrdenadas.forEach(mesa=>{
                const button=document.createElement('button');
                const statusClass=mesa.status.toLowerCase().replace(' ','_');
                button.className=`mesa-item ${statusClass}`;
                button.textContent=`Mesa ${mesa.mesa}\n(${mesa.status})`;
                button.onclick=()=>selecionarMesaParaAdicionar(mesa);
                container.appendChild(button);
            });
        }
        
        async function selecionarMesaParaAdicionar(mesa){
            if(mesa.status==='Livre'){
                alert('Esta mesa está livre. Não há comanda para adicionar itens.');
                return;
            }
            
            mesaSelecionadaAdicionar=mesa;
            document.getElementById('mesa-selecionada-info').style.display='block';
            document.getElementById('mesa-selecionada-info').textContent=`Mesa ${mesa.mesa} Selecionada (${mesa.status})`;
            
            await carregarComandasDaMesa(mesa.mesa);
            carregarCardapioAdicionar();
        }
        
        async function carregarComandasDaMesa(mesaId) {
            const { data: comandas, error } = await supabaseClient
                .from('pedidos')
                .select('*')
                .eq('mesa', mesaId)
                .neq('status', 'Fechado')
                .order('horario', { ascending: true });

            if (error) {
                console.error('Erro ao carregar comandas:', error);
                return;
            }

            comandasDaMesaSelecionada = comandas || [];
            renderSelecaoComandas();
        }
        
        function renderSelecaoComandas() {
            const container = document.getElementById('selecao-comandas');
            const infoContainer = document.getElementById('comanda-selecionada-info');
            
            if (comandasDaMesaSelecionada.length === 0) {
                container.innerHTML = '<p style="color: #ccc; text-align: center;">Nenhuma comanda ativa</p>';
                infoContainer.style.display = 'none';
                comandaSelecionadaParaAdicionar = null;
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = '<h4>Selecione a Comanda:</h4>';
            
            comandasDaMesaSelecionada.forEach(comanda => {
                const div = document.createElement('div');
                div.className = 'comanda-option';
                if (comandaSelecionadaParaAdicionar && comandaSelecionadaParaAdicionar.id === comanda.id) {
                    div.classList.add('selecionada');
                }
                
                const nome = comanda.nome_comanda || 'Comanda Principal';
                const total = comanda.total || 0;
                const status = comanda.status || 'Aberto';
                
                div.innerHTML = `
                    <strong>${nome}</strong>
                    <div style="font-size: 0.8em; color: #ccc;">
                        Status: ${status} | Total: R$ ${total.toFixed(2)} | Itens: ${(comanda.itens || []).length}
                    </div>
                `;
                
                div.onclick = (event) => {
                    selecionarComandaParaAdicionar(comanda, event.currentTarget);
                }
                container.appendChild(div);
            });
            
            if (!comandaSelecionadaParaAdicionar && comandasDaMesaSelecionada.length > 0) {
                const firstOption = container.querySelector('.comanda-option');
                if (firstOption) {
                    selecionarComandaParaAdicionar(comandasDaMesaSelecionada[0], firstOption);
                }
            }
        }
        
        function selecionarComandaParaAdicionar(comanda, element) {
            comandaSelecionadaParaAdicionar = comanda;
            const nome = comanda.nome_comanda || 'Comanda Principal';
            
            document.getElementById('comanda-selecionada-info').style.display = 'block';
            document.getElementById('comanda-selecionada-info').textContent = `Comanda Selecionada: ${nome}`;
            
            const options = document.querySelectorAll('.comanda-option');
            options.forEach(opt => opt.classList.remove('selecionada'));
            if (element) {
                element.classList.add('selecionada');
            }
        }
        
        async function carregarCardapioAdicionar(){
            if(cardapioItens.length===0){
                const{data}=await supabaseClient.from('cardapio').select('*').order('categoria').order('nome_item');
                cardapioItens=data||[];
            }
            const container=document.getElementById('adicional-cardapio-container');
            container.innerHTML='';
            
            if (!mesaSelecionadaAdicionar) {
                container.innerHTML = '<p style="color: #ccc; text-align: center;">Selecione uma mesa primeiro</p>';
                return;
            }
            
            let categorias={};
            cardapioItens.forEach(item=>{
                if(item.categoria){
                    if(!categorias[item.categoria])categorias[item.categoria]=[];
                    categorias[item.categoria].push(item);
                }
            });
            for(const[categoria,itens]of Object.entries(categorias)){
                const h4=document.createElement('h4');
                h4.textContent=categoria;
                h4.style.color='#ff8c00';
                h4.style.marginTop='15px';
                container.appendChild(h4);
                itens.forEach(i=>{
                    const div=document.createElement('div');
                    div.className='item-cardapio';
                    div.innerHTML=`
                        <span class="item-info">${i.nome_item}</span>
                        <span class="item-preco">R$ ${i.preco.toFixed(2).replace('.',',')}</span>
                        <button class="add-btn" onclick="adicionarItem(${i.id},'${i.nome_item.replace(/'/g,"\\'")}',${i.preco})">+</button>
                    `;
                    container.appendChild(div);
                });
            }
        }
        
        async function adicionarItem(itemId,nome,preco){
            if(!mesaSelecionadaAdicionar){
                alert('Selecione uma mesa primeiro!');
                return;
            }
            
            if(!comandaSelecionadaParaAdicionar){
                alert('Selecione uma comanda primeiro!');
                return;
            }
            
            const{data:pedido,error}=await supabaseClient.from('pedidos').select('itens,total').eq('id',comandaSelecionadaParaAdicionar.id).single();
            if(!pedido){
                alert('Erro ao buscar pedido!');
                return;
            }
            
            let itens=pedido.itens||[];
            const idx=itens.findIndex(i=>i.id===itemId);
            
            if(idx>-1){
                itens[idx].quantidade+=1;
            }else{
                itens.push({id:itemId,nome,preco,quantidade:1});
            }
            
            const novoTotal=(pedido.total||0)+preco;
            
            await supabaseClient.from('pedidos').update({
                itens,
                total:novoTotal,
                status:'Em Preparo'
            }).eq('id',comandaSelecionadaParaAdicionar.id);
            
            alert(`${nome} adicionado à comanda ${comandaSelecionadaParaAdicionar.nome_comanda || 'Principal'}!`);
            fetchPedidos();
            
            await carregarComandasDaMesa(mesaSelecionadaAdicionar.mesa);
        }
        
        async function calcularCaixaDoDia(){
            try{
                const hoje=new Date().toISOString().split('T')[0];
                const{data}=await supabaseClient.from('pedidos').select('total,forma_pagamento,horario_fecha').eq('status','Fechado').not('horario_fecha','is',null);
                let total=0,count=0,formas={'Cartao Debito':0,'Cartao Credito':0};
                (data||[]).forEach(p=>{
                    if(p.horario_fecha&&p.horario_fecha.startsWith(hoje)){
                        total+=p.total;
                        count++;
                        if(formas[p.forma_pagamento]!==undefined){
                            formas[p.forma_pagamento]+=p.total;
                        }
                    }
                });
                document.getElementById('total-caixa').textContent=`R$ ${total.toFixed(2).replace('.',',')}`;
                document.getElementById('contagem-pedidos').textContent=count;
                const formasDiv=document.getElementById('totais-por-forma');
                formasDiv.innerHTML='<h5 style="margin-top:15px;color:#ff8c00;">Por Forma:</h5>'+Object.entries(formas).map(([f,v])=>v>0?`<p>${f}: R$ ${v.toFixed(2).replace('.',',')}</p>`:'').join('');
                
                // 🆕 Garantir que o status de bloqueio seja aplicado no polling
                updateCaixaBlockStatus();
            }catch(err){
                console.error(err);
            }
        }
        
        function abrirModalFecharConta(pedidoId){
            const pedido=pedidosAtuais.find(p=>p.id===pedidoId);
            if(!pedido)return;
            pedidoAtualModal=pedido;
            
            // 🆕 Implementação da Taxa de Serviço (10%)
            const subtotal = (pedido.total || 0); 
            taxaServico = subtotal * 0.10;
            totalCom10Percent = subtotal + taxaServico;
            
            document.getElementById('modal-mesa-num').textContent=pedido.mesa;
            document.getElementById('modal-subtotal').textContent=subtotal.toFixed(2).replace('.',',');
            document.getElementById('modal-taxa-servico').textContent=taxaServico.toFixed(2).replace('.',',');
            document.getElementById('modal-total').textContent=totalCom10Percent.toFixed(2).replace('.',',');
            
            const nomeComanda = pedido.nome_comanda || 'Comanda Principal';
            document.getElementById('modal-itens-lista').innerHTML=`
                <h4>${nomeComanda}</h4>
                <ul class="lista-itens">${(pedido.itens||[]).map(i=>`<li>${i.quantidade}x ${i.nome} - R$ ${(i.quantidade*i.preco).toFixed(2).replace('.',',')}</li>`).join('')}</ul>
            `;
            
            document.getElementById('modal-forma-pagamento').value='';
            document.getElementById('valor-recebido').value='';
            document.getElementById('campo-dinheiro').style.display='none';
            document.getElementById('troco-info').style.display='none';
            document.getElementById('modal-fechar-conta').style.display='block';
        }
        
        function fecharModalConta(){
            document.getElementById('modal-fechar-conta').style.display='none';
            pedidoAtualModal=null;
            totalCom10Percent = 0;
            taxaServico = 0;
        }
        
        document.getElementById('modal-forma-pagamento').onchange=function(){
            document.getElementById('campo-dinheiro').style.display=this.value==='Dinheiro'?'block':'none';
            document.getElementById('troco-info').style.display='none';
        };
        
        function calcularTroco(){
            const total=totalCom10Percent;
            const recebido=parseFloat(document.getElementById('valor-recebido').value)||0;
            const troco=recebido-total;
            if(recebido>=total&&recebido>0){
                document.getElementById('troco-info').style.display='block';
                document.getElementById('valor-troco').textContent=troco.toFixed(2).replace('.',',');
            }else{
                document.getElementById('troco-info').style.display='none';
            }
        }
        
        async function confirmarFechamentoConta(){
            if(!pedidoAtualModal)return;
            const forma=document.getElementById('modal-forma-pagamento').value;
            if(!forma)return alert('Selecione a forma de pagamento!');
            
            const totalFinal = totalCom10Percent;
            let valorRecebido=null,troco=0;
            
            if(forma==='Dinheiro'){
                valorRecebido=parseFloat(document.getElementById('valor-recebido').value);
                if(!valorRecebido||valorRecebido<totalFinal)return alert('Valor insuficiente!');
                troco=valorRecebido-totalFinal;
            }
            
            const { data: comandasRestantes } = await supabaseClient
                .from('pedidos')
                .select('id')
                .eq('mesa', pedidoAtualModal.mesa)
                .neq('status', 'Fechado');
            
            await supabaseClient.from('pedidos').update({
                status:'Fechado',
                forma_pagamento:forma,
                valor_recebido:valorRecebido,
                troco:troco,
                total: totalFinal, // O total final com 10%
                taxa_servico: taxaServico, // Valor da taxa de serviço
                horario_fecha:new Date().toISOString()
            }).eq('id',pedidoAtualModal.id);
            
            const comandasAbertasRestantes = comandasRestantes ? comandasRestantes.filter(c => c.id !== pedidoAtualModal.id) : [];
            if (comandasAbertasRestantes.length === 0) {
                await supabaseClient.from('mesas_status')
                    .update({ status: 'Livre', pedido_id: null })
                    .eq('mesa', pedidoAtualModal.mesa);
            }
            
            imprimirComprovante(pedidoAtualModal, forma, valorRecebido, troco, taxaServico, totalFinal);
            fecharModalConta();
            fetchPedidos();
            fetchMesas();
            calcularCaixaDoDia();
            alert('Conta fechada!');
        }
        
function imprimirComprovante(pedido,forma,recebido,troco,taxaServico,totalFinal){
    const dataHora=new Date().toLocaleString('pt-BR');
    const nomeComanda = pedido.nome_comanda || 'Comanda Principal';
    const subtotal = totalFinal - taxaServico;
    
    let html=`
        <div style="font-family:monospace;padding:15px;font-size:14pt;line-height:1.4;color:#000000;">
            <h2 style="text-align:center;font-size:20pt;margin-bottom:8px;color:#000000;">
                <strong>ESPETINHO GESSELO</strong>
            </h2>
            <h3 style="text-align:center;font-size:18pt;margin-top:5px;margin-bottom:15px;color:#000000;">
                <strong>COMPROVANTE</strong>
            </h3>
            <p style="text-align:center;font-size:13pt;margin-bottom:20px;color:#000000;">
                <strong>${dataHora}</strong>
            </p>
            <p style="font-size:13pt;margin:10px 0;color:#000000;">
                <strong>Mesa: ${pedido.mesa}</strong>
            </p>
            <p style="font-size:13pt;margin:10px 0;color:#000000;">
                <strong>Comanda: ${nomeComanda}</strong>
            </p>
            <h4 style="font-size:15pt;margin:20px 0 12px 0;border-bottom:2px solid #000;padding-bottom:8px;color:#000000;">
                <strong>ITENS:</strong>
            </h4>
            <ul style="list-style:none;padding:0;margin:0;">
                ${(pedido.itens||[]).map(i=>`
                    <li style="font-size:13pt;margin:8px 0;padding:5px 0;border-bottom:1px dashed #000;color:#000000;">
                        <strong>${i.quantidade}x ${i.nome} - R$ ${(i.quantidade*i.preco).toFixed(2)}</strong>
                    </li>
                `).join('')}
            </ul>
            <div style="margin-top:20px;border-top:3px solid #000;padding-top:15px;">
                <p style="font-size:14pt;margin:10px 0;color:#000000;">
                    <strong>SUBTOTAL: R$ ${subtotal.toFixed(2)}</strong>
                </p>
                <p style="font-size:10pt;margin:6px 0;color:#000000;">
                    <strong>Taxa de Serviço (10%): R$ ${taxaServico.toFixed(2)}</strong>
                </p>
                <p style="font-size:16pt;margin:15px 0;color:#000000;">
                    <strong>TOTAL A PAGAR: R$ ${totalFinal.toFixed(2)}</strong>
                </p>
                <p style="font-size:14pt;margin:10px 0;color:#000000;">
                    <strong>Forma: ${forma}</strong>
                </p>
                ${forma==='Dinheiro'&&recebido?`
                    <p style="font-size:13pt;margin:8px 0;color:#000000;">
                        <strong>Recebido: R$ ${recebido.toFixed(2)}</strong>
                    </p>
                    <p style="font-size:13pt;margin:8px 0;color:#000000;">
                        <strong>Troco: R$ ${troco.toFixed(2)}</strong>
                    </p>
                `:''}
            </div>
            <p style="text-align:center;margin-top:25px;font-size:13pt;color:#000000;">
                <strong>Obrigado e Volte Sempre!</strong>
            </p>
        </div>
    `;
    document.getElementById('comanda-impressao').innerHTML=html;
    setTimeout(()=>window.print(),300);
}
        
        async function verificarNovasImpressoes() {
            if (isPrinting) {
                console.log('Já está imprimindo, aguardando...');
                return;
            }
            
            try {
                isPrinting = true;
                
                let query = supabaseClient
                    .from('impressoes_cozinha')
                    .select('*')
                    .order('data_hora', { ascending: true });

                if (ultimaImpressaoTimestamp) {
                    query = query.gt('data_hora', ultimaImpressaoTimestamp);
                }

                const { data, error } = await query;
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    console.log(`🆕 ${data.length} nova(s) impressão(ões) encontrada(s)`);
                    
                    for (const novaImpressao of data) {
                        ultimaImpressaoTimestamp = novaImpressao.data_hora;
                        
                        if (impressoesProcessadas.has(novaImpressao.id)) {
                            console.log(`Impressão ${novaImpressao.id} já processada, pulando...`);
                            continue;
                        }
                        
                        impressoesProcessadas.add(novaImpressao.id);
                        
                        console.log('🖨️ Imprimindo comanda:', novaImpressao.id, 'Mesa:', novaImpressao.mesa);
                        
                        tocarAlertaSonoro();
                        
                        await imprimirComandaCozinha(novaImpressao);
                        
                        await apagarImpressaoComConfirmacao(novaImpressao.id);
                        
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao verificar novas impressões:', error);
            } finally {
                isPrinting = false;
            }
        }

        async function apagarImpressaoComConfirmacao(impressaoId) {
            let tentativas = 3;
            
            while (tentativas > 0) {
                try {
                    const { error } = await supabaseClient
                        .from('impressoes_cozinha')
                        .delete()
                        .eq('id', impressaoId);
                    
                    if (error) {
                        throw error;
                    }
                    
                    console.log('✅ Impressão apagada do banco:', impressaoId);
                    return;
                } catch (error) {
                    console.error(`❌ Tentativa ${4 - tentativas} falhou ao apagar impressão ${impressaoId}:`, error);
                    tentativas--;
                    
                    if (tentativas > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
            
            console.error('❌ Não foi possível apagar a impressão após 3 tentativas:', impressaoId);
        }

        function imprimirComandaCozinha(impressao) {
            return new Promise((resolve) => {
                console.log('📄 Preparando impressão...');
                document.getElementById('comanda-impressao').innerHTML = impressao.conteudo;
                
                setTimeout(() => {
                    console.log('🖨️ Acionando impressora...');
                    window.print();
                    
                    setTimeout(() => {
                        document.getElementById('comanda-impressao').innerHTML = '';
                        console.log('✅ Impressão concluída');
                        resolve();
                    }, 800);
                }, 300);
            });
        }

        function iniciarImpressaoAutomatica() {
            if (impressaoInterval) return;
            
            impressaoInterval = setInterval(verificarNovasImpressoes, 1000);
            console.log('🚀 Impressão automática iniciada - Verificando a cada 1 segundo');
        }

        function pararImpressaoAutomatica() {
            if (impressaoInterval) {
                clearInterval(impressaoInterval);
                impressaoInterval = null;
            }
        }
        
        setInterval(() => {
            if (impressoesProcessadas.size > 100) {
                console.log('🧹 Limpando set de impressões processadas...');
                impressoesProcessadas.clear();
            }
        }, 60000);
        
        function abrirModalFechamentoCaixa() {
            if (caixaFechadaHoje) {
                alert('O caixa está bloqueado. Desbloqueie-o antes de fechar.');
                return;
            }
            
            const hoje = new Date().toLocaleDateString('pt-BR');
            const total = document.getElementById('total-caixa').textContent;
            const pedidos = document.getElementById('contagem-pedidos').textContent;
            const formasDiv = document.getElementById('totais-por-forma').innerHTML;
            
            document.getElementById('resumo-caixa').innerHTML = `
                <h3 style="color: #4CAF50;">Resumo do Caixa - ${hoje}</h3>
                <p><strong>Total Fechado:</strong> ${total}</p>
                <p><strong>Número de Pedidos:</strong> ${pedidos}</p>
                <div>${formasDiv}</div>
                <p style="margin-top: 15px; color: #ff8c00;"><strong>Confirme o fechamento do caixa do dia.</strong></p>
            `;
            document.getElementById('modal-fechar-caixa').style.display = 'block';
        }
        
        function fecharModalFecharCaixa() {
            document.getElementById('modal-fechar-caixa').style.display = 'none';
        }
        
        async function confirmarFechamentoCaixa() {
            try {
                const totalAtual = parseFloat(document.getElementById('total-caixa').textContent.replace('R$ ', '').replace(',', '.'));
                
                if (totalAtual > 0) {
                    await baixarCaixaPDF();
                    await limparCaixaDoDia();
                } else if (totalAtual === 0) {
                     if(!confirm('O total do caixa é R$ 0,00. Deseja prosseguir com o bloqueio e fechar o caixa (sem gerar PDF ou limpar pedidos fechados)?')) return;
                }
                
                caixaFechadaHoje = true; // Define o bloqueio
                updateCaixaBlockStatus(); // Atualiza a interface (aplica o blur)
                fecharModalFecharCaixa();
                alert('Caixa fechado com sucesso! Ações bloqueadas.');
            } catch (error) {
                alert('Erro ao fechar caixa: ' + error.message);
            }
        }
        
        // 🆕 NOVO: FUNÇÃO PARA BLOQUEAR O CAIXA MANUALMENTE
        function bloquearCaixaManualmente() {
            if (confirm('Tem certeza que deseja BLOQUEAR o caixa? Os dados e ações serão desfocados/ocultados.')) {
                caixaFechadaHoje = true;
                updateCaixaBlockStatus();
                alert('Caixa bloqueado. Use a senha para desbloquear.');
            }
        }

        // 🆕 NOVO: ABRE O MODAL DE SENHA PARA DESBLOQUEIO
        function abrirModalDesbloqueio() {
            document.getElementById('input-senha-desbloqueio').value = '';
            document.getElementById('mensagem-erro-desbloqueio').style.display = 'none';
            document.getElementById('modal-desbloqueio').style.display = 'block';
            document.getElementById('input-senha-desbloqueio').focus();
        }

        // 🆕 NOVO: FECHA O MODAL DE SENHA PARA DESBLOQUEIO
        function fecharModalDesbloqueio() {
            document.getElementById('modal-desbloqueio').style.display = 'none';
        }
        
        // 🆕 NOVO: VERIFICA A SENHA PARA DESBLOQUEIO
        function verificarSenhaDesbloqueio() {
            const senhaDigitada = document.getElementById('input-senha-desbloqueio').value;
            const msgErro = document.getElementById('mensagem-erro-desbloqueio');

            if (senhaDigitada === SENHA_DESBLOQUEIO) {
                caixaFechadaHoje = false; // Desbloqueia
                updateCaixaBlockStatus();
                fecharModalDesbloqueio();
                alert('Caixa desbloqueado com sucesso!');
            } else {
                msgErro.style.display = 'block';
                document.getElementById('input-senha-desbloqueio').value = '';
                setTimeout(() => msgErro.style.display = 'none', 3000);
            }
        }

        // 🆕 FUNÇÃO PARA BLOQUEAR/DESBLOQUEAR AS AÇÕES E O BLUR
        function updateCaixaBlockStatus() {
            const caixaContainer = document.getElementById('caixa-do-dia');
            const caixaContent = document.getElementById('caixa-content');
            const caixaActions = document.getElementById('caixa-actions-container');
            const fecharCaixaBtn = document.getElementById('btn-fechar-caixa');
            const bloquearCaixaBtn = document.getElementById('btn-bloquear-caixa');
            const desbloquearCaixaBtn = document.getElementById('btn-desbloquear-caixa');
            let statusBloqueado = document.getElementById('caixa-status-bloqueado');

            if (caixaFechadaHoje) {
                // Modo Bloqueado: Aplica Blur, Esconde ações, mostra botão de Desbloqueio
                if (caixaContent) caixaContent.classList.add('blurry');
                if (caixaActions) caixaActions.style.display = 'none';
                if (fecharCaixaBtn) fecharCaixaBtn.style.display = 'none';
                if (bloquearCaixaBtn) bloquearCaixaBtn.style.display = 'none';
                if (desbloquearCaixaBtn) desbloquearCaixaBtn.style.display = 'block';

                if (!statusBloqueado) {
                    statusBloqueado = document.createElement('p');
                    statusBloqueado.id = 'caixa-status-bloqueado';
                    statusBloqueado.style.cssText = 'color: red; font-weight: bold; margin-top: 10px; text-align: center;';
                    statusBloqueado.textContent = '🔒 CAIXA FECHADO/BLOQUEADO';
                    caixaContainer.prepend(statusBloqueado);
                }
            } else {
                // Modo Desbloqueado: Remove Blur, Mostra ações, mostra botão de Bloqueio manual
                if (caixaContent) caixaContent.classList.remove('blurry');
                if (caixaActions) caixaActions.style.display = 'flex';
                if (fecharCaixaBtn) fecharCaixaBtn.style.display = 'block';
                if (bloquearCaixaBtn) bloquearCaixaBtn.style.display = 'block';
                if (desbloquearCaixaBtn) desbloquearCaixaBtn.style.display = 'none';
                if (statusBloqueado) statusBloqueado.remove();
            }
        }
        
        async function baixarCaixaPDF(){
            if (caixaFechadaHoje) {
                alert('Ações de caixa bloqueadas. Desbloqueie-o antes de continuar.');
                return;
            }
            
            const hoje=new Date().toISOString().split('T')[0];
            const{data}=await supabaseClient.from('pedidos').select('*').eq('status','Fechado').not('horario_fecha','is',null);
            
            let total=0,count=0,formas={'Dinheiro':0,'Cartao Debito':0,'Cartao Credito':0,'PIX':0}, totalTaxaServico = 0;
            const pedidosHoje=[];
            (data||[]).forEach(p=>{
                if(p.horario_fecha&&p.horario_fecha.startsWith(hoje)){
                    total+=p.total;
                    count++;
                    pedidosHoje.push(p);
                    totalTaxaServico += p.taxa_servico || 0;
                    if(formas[p.forma_pagamento]!==undefined){
                        formas[p.forma_pagamento]+=p.total;
                    }
                }
            });
            
            const{jsPDF}=window.jspdf;
            const doc=new jsPDF();
            doc.setFontSize(18);
            doc.text('ESPETINHO GESSELO',105,20,{align:'center'});
            doc.setFontSize(14);
            doc.text('RELATÓRIO DE CAIXA',105,30,{align:'center'});
            doc.setFontSize(10);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`,20,45);
            doc.text(`Total Bruto (com 10%): R$ ${total.toFixed(2)}`,20,55);
            doc.text(`Total Taxa Serviço: R$ ${totalTaxaServico.toFixed(2)}`,20,65);
            doc.text(`Pedidos: ${count}`,20,75);
            
            let y=90;
            doc.setFontSize(12);
            doc.text('Por Forma de Pagamento:',20,y);
            y+=10;
            doc.setFontSize(10);
            for(const[forma,valor]of Object.entries(formas)){
                if(valor>0){
                    doc.text(`${forma}: R$ ${valor.toFixed(2)}`,25,y);
                    y+=8;
                }
            }
            
            y+=10;
            doc.setFontSize(12);
            doc.text('Detalhamento:',20,y);
            y+=10;
            doc.setFontSize(9);
            pedidosHoje.forEach(p=>{
                if(y>270){
                    doc.addPage();
                    y=20;
                }
                const nomeComanda = p.nome_comanda || 'Principal';
                doc.text(`Mesa ${p.mesa} - ${nomeComanda} - R$ ${p.total.toFixed(2)} - ${p.forma_pagamento||'N/A'}`,25,y);
                y+=6;
            });
            
            doc.save(`caixa_${hoje}.pdf`);
        }
        
        async function limparCaixaDoDia(){
            if (caixaFechadaHoje) {
                alert('Ações de caixa bloqueadas. Desbloqueie-o antes de continuar.');
                return;
            }

            if(!confirm('ATENÇÃO: Isso irá DELETAR todos os pedidos fechados de hoje do banco de dados! Certifique-se de ter feito backup. Deseja continuar?'))return;
            if(!confirm('Tem ABSOLUTA CERTEZA? Esta ação NÃO pode ser desfeita!'))return;
            
            try{
                const hoje=new Date().toISOString().split('T')[0];
                
                const{data:pedidosHoje}=await supabaseClient
                    .from('pedidos')
                    .select('id,horario_fecha')
                    .eq('status','Fechado')
                    .not('horario_fecha','is',null);
                
                const idsParaDeletar=pedidosHoje
                    .filter(p=>p.horario_fecha&&p.horario_fecha.startsWith(hoje))
                    .map(p=>p.id);
                
                if(idsParaDeletar.length===0){
                    alert('Não há pedidos fechados hoje para limpar.');
                    return;
                }
                
                const{error}=await supabaseClient
                    .from('pedidos')
                    .delete()
                    .in('id',idsParaDeletar);
                
                if(error)throw error;
                
                alert(`✓ ${idsParaDeletar.length} pedidos foram removidos do sistema!`);
                calcularCaixaDoDia();
            }catch(err){
                console.error('Erro ao limpar caixa:',err);
                alert('Erro ao limpar caixa! '+err.message);
            }
        }
        
        window.addEventListener('beforeunload',()=>{
            clearInterval(pollingIntervalPedidos);
            clearInterval(pollingIntervalMesas);
            clearInterval(pollingIntervalCaixa);
            pararImpressaoAutomatica();
        });
    </script>
</body>
</html>
